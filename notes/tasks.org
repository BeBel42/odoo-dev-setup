#+title: Tasks

* FIXME [[https://www.odoo.com/odoo/project/1251/tasks/5162567][[Payroll] Work Entry Types screen]]
#+begin_src bash :results silent
../o -c master-payroll-change_work_entry_types_views-mlef >&2
#+end_src
=-m hr_work_entry,hr_payroll=
=-m hr_work_entry,hr_payroll,l10n_be_hr_payroll=
=-m hr_work_entry,hr_payroll,l10n_be_hr_payroll,l10n_be_hr_payroll_group_s,l10n_be_hr_payroll_partena,l10n_be_hr_payroll_ucm,l10n_be_hr_payroll_sd_worx --template work_entry_be_all=
=-m hr_work_entry,hr_payroll,l10n_it_hr_payroll,l10n_it_hr_payroll_group_s,l10n_it_hr_payroll_partena,l10n_it_hr_payroll_ucm,l10n_it_hr_payroll_sd_worx --template work_entry_it_all=

[[project:community/addons/hr_work_entry/views/hr_work_entry_views.xml::244][base Work Entry Type form view]]
[[project:enterprise/l10n_be_hr_payroll/views/hr_work_entry_views.xml::1][l10n_be work entry ptype form view main override]]
[[project:enterprise/l10n_be_hr_payroll_sd_worx/views/hr_work_entry_type_views.xml::1][l10n_be work entry type form view SD Worx override]]
** Spec
*** [X] [[https://link.excalidraw.com/l/65VNwvy7c4X/4LJSOZo8W3D][Change UX]]
**** [X] Form view
I did not do other locales
I did everything except *Unpaid in Joint Committee*
Which is a new field with new logic. David proposed to make it in another task.
**** [X] List view
**** [X] Filters
*** [X] Set tooltips
**** [X] Payroll Code : "The code is used as a reference in salary rules. Careful, changing an existing code can lead to unwanted behaviors."
**** [X] Duration Rounding (old Rounding field) : "In the Payslip Worked Days, duration can be rounded if needed".
**** [X] Rounding Method : "According to the Duration Rounding, the duration will be rounded to closest, top, or bottom value".
**** [X] Unpaid in Structures : "If a Structure is selected, the work entry of this type will bot be valuated in the computation."
**** CANCEL Unpaid in Joint Committee : "If a Joint Committee is selected, the work entry of this type will not be valuated in the computation. This selection works in addition to the Unpaid in Structures, conditions are cumulative."
**** [X] Paid Time Off Eligibility (old Keep Time Off Right) : "The work entry type will be taken into account for the computation of the annual time off allocation"
**** [X] Time Credit : "Time Credit are specific work entry types used in the computation of the working rate in the working schedule. A Time Credit work entry type is considered as work."
**** [X] SDWorx : "Code must be 4 characters long."
**** [X] Meal Voucher + Representation Fees + Private Car Reimbursement : "The work entry type will make the day eligible to the related Benefit and increase the amount of days on the month."

*** [X] Remove "Unforeseen Absence", check the code (gmf thinks it's never used)
** DONE [[project:enterprise/hr_work_entry_holidays_enterprise/views/hr_work_entry_views.xml::50][This crashes when installing with hr_payroll]]
It's because I removed the =time_off= group in the [[project:community/addons/hr_work_entry/views/hr_work_entry_views.xml::280][type view xml]]
** DONE Make migrations for modified fields
*** [X] is_unforeseen has been deleted
** CANCEL Joint committee now exists. Add it.
** DONE maybe keep "Code" after like "SDWorx Code" in .py file and just remove it in form view.
** DONE convert is_work (old bool) to work_type (Selection) in a migration
[[project:community/addons/hr_work_entry/models/hr_work_entry_type.py::28][Where is_work has been changed to work_type]]

[[project:upgrade/migrations/hr_work_entry/tests/test_work_type_reflects_is_work_19_1.py::6][File that tests it]]
* DONE [[https://www.odoo.com/odoo/project/1251/tasks/5156978][[Payroll] Reports clean up]]
#+begin_src bash :results silent
../o --checkout-community master \
     --checkout-enterprise master-payroll-reports_clean_up-mlef \
     --checkout-upgrade master-payroll-reports_clean_up-mlef >&2
#+end_src
** [X] Remove work entries analysis & move Headcount https://tinyurl.com/22mgvmqx
** [X] Move Paid Time Off Allocation to Time Off https://tinyurl.com/238nmtbn & https://tinyurl.com/2co433x9
** [X] L10N_BE : Removal "Meal Voucher"
** [X] Payroll : Move "time off" menu item https://tinyurl.com/28mjrxlm
** [X] L10N_BE : Remove "Group Insurance Export" https://tinyurl.com/2y3zy2eg


=-m l10n_be_hr_payroll=
Retire ton module prcq be_hr_payroll depend deja de hr_holidays donc tu peux override direct dans be_hr_payroll
** DONE Runbot tests fails
=-m l10n_ch_hr_payroll,account -t .test_01_account_tax_groups_tour=
* DONE [[https://www.odoo.com/odoo/project/1251/tasks/5156702][[mrp_workorder] Fix permission denied on Add Operator]]
** DONE prevenir mec de Github
* DONE [[https://www.odoo.com/odoo/project/1251/tasks/4762235][[Attendance] Load the Overview Page Faster]]
#+begin_src bash :results silent
../o -c master-make_overview_page_faster-mlef >&2
#+end_src
*Don't forget that it's a two branch task*
template name: =hr_attendance_1000=
#+begin_src python
for i in range(1000):
    self.env['hr.employee'].create({
        'name': f'Beep Boop {i}'
    })
    print(i)
print('committing...')
self.env.cr.commit()
print('Done')
#+end_src
when limit > total number of employees, then it does not display only 5 of them
[[project:community/addons/web/models/models.py::844][community/addons/web/models/models.py::844]] <- is where expand_groups is completely ditched instead of partially used
[[project:enterprise/hr_attendance_gantt/views/hr_attendance_gantt.xml::71][Where I would put groups_limit="20"]]
** formatted_read_group_behavior test
#+begin_src python
test1 = self.with_context(read_group_expand=True).formatted_read_group(
    domain=['|', '&', '&', ('check_in', '<', '2025-10-03 22:00:00'), '|', '&', ('check_in', '<', '2025-10-03 12:02:59'), ('check_out', '=', False), ('check_out', '>', '2025-10-02 22:00:00'), ('employee_id.active', '=', True), '&', ('check_out', '<', '2025-10-02 22:00:00'), ('check_in', '>', datetime.datetime(2025, 8, 3, 22, 0))],
    groupby=('employee_id',),
    aggregates=('id:array_agg',),
    having=tuple(),
    offset=0,
    limit=20, # below 1021, will only return 5 employees
    order="employee_id",
)
test2 = self.with_context(read_group_expand=True).formatted_read_group(
    domain=['|', '&', '&', ('check_in', '<', '2025-10-03 22:00:00'), '|', '&', ('check_in', '<', '2025-10-03 12:02:59'), ('check_out', '=', False), ('check_out', '>', '2025-10-02 22:00:00'), ('employee_id.active', '=', True), '&', ('check_out', '<', '2025-10-02 22:00:00'), ('check_in', '>', datetime.datetime(2025, 8, 3, 22, 0))],
    groupby=('employee_id',),
    aggregates=('id:array_agg',),
    having=tuple(),
    offset=0,
    limit=2000, # above 1021, will return all of them
    order="employee_id",
)
test3 = self.with_context(read_group_expand=True).formatted_read_group(
    domain=['|', '&', '&', ('check_in', '<', '2025-10-03 22:00:00'), '|', '&', ('check_in', '<', '2025-10-03 12:02:59'), ('check_out', '=', False), ('check_out', '>', '2025-10-02 22:00:00'), ('employee_id.active', '=', True), '&', ('check_out', '<', '2025-10-02 22:00:00'), ('check_in', '>', datetime.datetime(2025, 8, 3, 22, 0))],
    groupby=('employee_id',),
    aggregates=('id:array_agg',),
    having=tuple(),
    offset=0,
    limit=None, # return all of them
    order="employee_id",
)
#+end_src
** Talk with Yurgen
C'est [[project:community/addons/hr_attendance/models/hr_attendance.py::557][read_group_employee_id]] qui hacke read_group quand on groupe sur =employee_id=. Il devrait retourner tous mes employees (qui vont etre filtres par la pagination apres). Mais _il ne le fait pas_. Change ca.
** SQL query that only gets 5 groups
#+begin_src sql
SELECT
  "hr_attendance"."employee_id",
  ARRAY_AGG(
    "hr_attendance"."id"
    ORDER BY
      "hr_attendance"."id"
  )
FROM
  "hr_attendance"
  LEFT JOIN "hr_employee" AS "hr_attendance__employee_id" ON (
    "hr_attendance"."employee_id" = "hr_attendance__employee_id"."id"
  )
WHERE
  "hr_attendance__employee_id"."company_id" IN (1)
GROUP BY
  "hr_attendance"."employee_id",
  "hr_attendance__employee_id"."name"
ORDER BY
  "hr_attendance__employee_id"."name"
LIMIT
  20
#+end_src
** Reason for filtering myself
Everything is already fetched inf read_group_employee_id, so I can just fetch everything and filter myself.
*** What I could do
- Fetch the employees myself with filter
- Get Ids of filtered employees
- Use super().get_gantt_data() with a domain being the ids only
- *NOTE:* tu dois afficher tous les employees de l'entreprise dont tu es manager, ou juste tous les employees de l'entreprise si tu es admin
- *NOTE:* affiche tous ces employees sans condition si user_domain est TRUE, vu que de base tout le monde passe a ce moment-la donc osef des domains pour ca
- Si user_domain est pas TRUE alors tu dois afficher que les employees avec des attendances qui matchent les domains
** DONE tests don't work...
** DONE [[project:community/addons/hr_attendance/tests/test_hr_attendance_process.py::78][This test fails]]
* DONE [[https://www.odoo.com/odoo/project/1251/tasks/5082687][[Employee] Database without recruitment]]
#+begin_src bash :results silent
../o --checkout-community master-no_recruitment_employee_refactor-mlef \
     --checkout-enterprise master >&2
#+end_src

* DONE [[https://www.odoo.com/odoo/project/1251/tasks/5103739][[Employee] Version method overwrite fields]]
#+begin_src bash :results silent
../o --checkout-community saas-18.4-overridden_cron_work_phone-mlef \
     --checkout-enterprise saas-18.4 >&2
#+end_src
[[https://www.odoo.com/odoo/project.task/5079964][Autre lien de tache related]]
Y a deja eu une tache qui a fix le probleme en 18.3 que quand on changeait le num de l'entreprise, celui de l'employe etait change...
Ca fonctionne mais en 18.4, [[https://drive.google.com/file/d/1hufZwcVHU0nWbCTP7eSEY6KL0irC3qIm/view][le num de tel change encore quand on fait une operation avec une server action (update current version)]]
[[project:community/addons/hr/models/hr_employee.py::376][Where version is updated]]
[[project:community/addons/hr/models/hr_employee.py::587][Where phone is overridden]]
** Computes quand version change
- [[project:community/addons/hr/models/hr_employee.py::585][community/addons/hr/models/hr_employee.py::585]] phones
- [[project:community/addons/hr/models/hr_employee.py::698][community/addons/hr/models/hr_employee.py::698]] YES (all the image ones)
  But seems like the compute function has a condition [[project:community/addons/hr/models/hr_employee.py::718][like I did]]
- [[project:community/addons/hr/models/hr_employee.py::745][community/addons/hr/models/hr_employee.py::745]] YES but might change nothing (always same value)

* DONE [[https://www.odoo.com/odoo/project/1251/tasks/4762527][[Employee] Prevent Traceback When HR Users Access Shared Employee Links]]
Branch =18.0-fix_employee_share_permission_link-mlef=
#+begin_src bash :results silent
../o --checkout-community 18.0-fix_employee_share_permission_link-mlef \
     --checkout-enterprise 18.0 >&2
#+end_src
#+begin_src bash :results silent
./o -m hr --template hr
#+end_src
uncommenting all =private_car_plate= in [[project:community/addons/hr/views/hr_employee_views.xml::20][This file]] removes the traceback
In the network console tab, get_views returns public employee profile for private window, and employee for admin window.
So why still permission error when removing private_car_plate?
** Talk with Arthur
~group_hr_manager~ and ~group_hr_user~ are the only groups that can access private employee view
Try to see in js if user is in those groups before page load, else redirect to public employee view
Dans js y a doAction() pour faire une action pour ouvrir public employee
** DONE [[https://github.com/odoo/odoo/pull/228623#issuecomment-3381553847][Aerospacelab Issue]]
[[project:enterprise/mrp_workorder/views/mrp_workorder_views.xml::459][Changer hr.employee en hr.employee.public]]
* FIXME [[https://www.odoo.com/odoo/project/1251/tasks/5106638][[hr_attendance] Extra hours smart button gives stacktrace]]
- [[project:community/addons/hr_attendance/views/hr_employee_view.xml::131][where check_in defined for list view]]
#+begin_src bash :results silent
../o --checkout-community master-fix_extra_hours_stack_trace-mlef \
     --checkout-enterprise master >&2
#+end_src

check_in seems to be defined in attendances and not allocations...
** [[project:community/addons/hr_attendance/static/src/views/extra_hours_list_view.js::30][community/addons/hr_attendance/static/src/views/extra_hours_list_view.js::30]]
shouldDisplay is true when display_extra_hours is true
check_in is in domain from searchModel

* DONE [[https://www.odoo.com/odoo/my-tasks/5026228][[hr_holidays] Add back a well-formatted "Extra Hours" section in the Time Off dashboard]]
Made from [[https://www.odoo.com/odoo/all-tasks/4774528][task 4774528]]
#+begin_src bash :results silent
../o --checkout-community master-hr_holidays_attendance-add_well_formatted_extra_hours-mlef \
     --checkout-enterprise master >&2
#+end_src
#+begin_src bash
./o -m hr_holidays_attendance --template holidays_attendance
#+end_src

Branch: =master-hr_holidays_attendance-add_well_formatted_extra_hours-mlef=

=-m hr_attendance,hr_holidays,hr_contract=

- Add the employee.total_overtime if > 0 and if overtime is not checked on Hide on Dashboard && Deduct Extra Hours is checked
  This spec has been changed when talking with bedo

** DONE extra hours does not appear on the dashboard anymore...
** DONE add tests

** DONE [[https://runbot.odoo.com/runbot/batch/2095917/build/87408979][FIX the Runbot Issues!]]
=./o -m hr_attendance,hr_holidays,hr_contract -t :TestExpiringLeaves=

** DONE Natalie's code crashes (unable to test via gui)
[[project:community/addons/hr_holidays_attendance/models/hr_employee.py::17][community/addons/hr_holidays_attendance/models/hr_employee.py::17]]
** Talk with bedo
hr_employee
pour leave types qui demandent pas allocations & qui sont coches sur "deduct extra hours", dans _get_consumed_leaves(), je dois rajouter dans var envoyee sur discord, mais False au lieu de [allocation] (False c'est l'allocation qui n'en es pas une)

=allocations_leaves_consumed[<employee>][<holiday_status>][False]=

Je dois faire le allocations_data.update({}) mais dans false

*Extra stuff to do*
Time off type > Si coche / decoche requires allocation, alors decoche / coche hide on dashboard
Idem pour deduct extra hours
- Do a computed property, stored readonly=false so that it change (and can still be changed by user) the checkbox


** Talk with bedo 2
garder changements ligne 586 dans hr employee:
#+BEGIN_SRC
leave_type_data[False]['virtual_leaves_taken'] += allocated_time
leave_type_data[False]['virtual_remaining_leaves'] -= allocated_time
if leave.state == 'validate':
    leave_type_data[False]['remaining_leaves'] -= allocated_time
    leave_type_data[False]['leaves_taken'] += allocated_time
#+END_SRC
Prendre tous les overtime_Ids de l;employee et y prendre leur duration_real
Et apres dans la get_allocation_data overriden, dans le if (pas le else) je rajoute ca sur max_Leaves, virtual_remaining_leaves and remaining_leaves


Et retirer dans la condition le =or not leave_type.requires_allocation=

* WAIT [[https://www.odoo.com/odoo/my-tasks/4985543][[L10N_BE_Payroll] Changes since previous version]]
**master**
Chatter seems to be mail_message.py
OR mail_thread.py (hr_version inherits it)
Adding =tracking=True= in a python field makes the chatter send a message each time it is modified

in 18.3, the summary changes are in [[project:enterprise/hr_contract_salary/controllers/main.py::849]]
In the same file, the function is used. But I can't find a way to get the same logging as in the picture

The diff message is in send_diff_email:
[[project:enterprise/hr_contract_salary/controllers/main.py::899]]
To get it, you have to sign a new _offer_ in the Recruitment app.
I did it with Billy Kyle

=-m l10n_be_hr_payroll,hr_contract_salary=
Xavier (xbo) connait les trucs sur les tracking values (groups specifiques + perms, etc.)

WIP on branch *master-hr_contract_salary-add_diff_message_on_employee-mlef*

** FIXME recent PRs made changes on code I am supposed to delete
[[project:enterprise/hr_contract_salary/controllers/main.py::683][enterprise/hr_contract_salary/controllers/main.py::683]]

** talk with xavier (xbo)
Try to replace [[project:enterprise/hr_contract_salary/controllers/main.py::714]]
By =employee.create_version()=
[[project:community/addons/hr/models/hr_employee.py::383]]
Vals (in theory) are the same as the one passed in old code.

After that, with the small [[https://github.com/odoo/odoo/pull/222744/files#diff-1c37517a76b393d1d30c2b03e96611643a747d12c13b086653989f4068c660b2R447-R450][pr he sent]] tracking values should take care of it. Maybe git pull to get the changes.

After that, delete the old diff message you made
* WAIT [[[https://www.odoo.com/odoo/my-tasks/5013546][Employee] Migrate all "general" data to demo data]]
General data: =community/addons/hr/data/hr_data.xml=
Demo data: =community/addons/hr/data/hr_demo.xml=
Task is awaiting for some talks. Arthur knows a bit about it. He comes back from holidays on the 13 of aug


* FIXME [[https://www.odoo.com/odoo/project/1251/tasks/4784231][[Recruitment] Make the interview links expire when a candidate is refused/archived or has signed]]
#+begin_src bash :results silent
../o --checkout-community master-hr-recruitment-survey-expire-ksni \
     --checkout-enterprise master >&2
#+end_src
#+begin_src bash
./o -m hr_recruitment_survey --template interviews
#+end_src

#+RESULTS:

[[https://github.com/odoo/odoo/pull/210980][Community PR]]
[[https://runbot.odoo.com/runbot/bundle/master-hr-recruitment-survey-expire-ksni-371641][Runbot]]
/Prakash/ has given great info in the discord channel

* DONE [[https://www.odoo.com/odoo/project/1251/tasks/5048292][[Appraisal] Default employee_id on goal creation]]
#+begin_src bash :results silent
../o --checkout-community saas-18.2 \
     --checkout-enterprise saas-18.2-default_employee_id_on_goal_creation-mlef >&2
#+end_src
[[https://github.com/odoo/enterprise/pull/93522][pr]]
=-m hr_appraisal=
Version *saas-18.2*
Branch: =saas-18.2-default_employee_id_on_goal_creation-mlef=
Put on context when clicking on "Goals" from employee the employee id, if directly click on "Goals" then leave the employee field empty.
[[project:enterprise/hr_appraisal/views/hr_appraisal_views.xml::27][Goals smart button]]
[[project:enterprise/hr_appraisal/models/hr_appraisal.py::536][Context passed to action]]
** DONE forward port (wait for [[https://runbot.odoo.com/runbot/bundle/19-0-saas-18-2-default-employee-id-on-goal-creation-mlef-468974-fw-406044][runbot]])
- #96687 [FIX] hr_appraisal: Goal creation default employee
#+begin_src bash :results silent
../o --checkout-community 19.0 \
     --checkout-enterprise 19.0-saas-18.2-default_employee_id_on_goal_creation-mlef-468974-fw >&2
#+end_src
#+begin_src bash
./o -m hr_appraisal -d -t :TestHrAppraisalGoal
#+end_src
* CANCEL [[https://www.odoo.com/odoo/my-tasks/4980966][[l10n_in_Payroll] Fix the basic rule calculation condition in the Python code]]
+18.0+ *master*
=master-l10n_in_hr_payroll-minimum_wage_check-mlef=
PR:
https://github.com/odoo/enterprise/pull/35602

File:
l10n_in_hr_payroll/data/hr_rule_parameters_data.xml

Hint:
https://github.com/odoo/enterprise/pull/35602#discussion_r1119774480

Rule (Basic Salary, India: Regular Pay):
=result = max(payslip._rule_parameter('l10n_in_basic_value'), payslip.paid_amount * payslip._rule_parameter('l10n_in_basic_percent') * payslip._rule_parameter('l10n_in_basic_days'))=
Since payslip.paid_amout is 0, it thus does =max(700, 0)=

- empecher MONTHLY wage to be under the value
- et retirer max dans rule
- wage_hourly = hourly wage
- wage = monthly wage
- on master and not 18.0

** [X]
should I continue with what I was doing? Like the check, migration, etc.?
If so, the hourly_wage needs to be converted to a monthly wage to be checked against l10n_in_basic_value (?)
-> Update: it has been CANCELLED

** Talk with David PO
***  Should ask suga for minimum wage (the monthly, the hourly and the fixed one) and use those values instead
***  The constraint will have to be applied to all wage types. Not just monthly
***  Do not add case at right of payroll tab
***  Remove "From l10n_basic_value" from ui error message
***  The test will have to be changed accordingly
***  Migrate it all to 19.0 (19.1?)

* DONE [[https://www.odoo.com/odoo/my-tasks/5042323][[Payroll] Work entries]]
=-m hr_payroll=
The code that check if the work entry is not validated before deletion can be found at:
- [[project:community/addons/hr_work_entry/static/src/views/work_entry_calendar/work_entry_calendar_controller.js::151]] (for work entries view from employees)
  - [[project:enterprise/hr_work_entry_enterprise/static/src/work_entries_gantt_renderer.js::272]] (for work entries view from payroll)

* CANCEL [[https://www.odoo.com/odoo/my-tasks/4774528][[Attendance] Support Tolerance-Based Extra Hours Calculation Without Active Contract]]
=-m hr_attendance,hr_holidays,hr_contract=
=community/addons/hr_holidays/static/src/dashboard/time_off_card.xml= pour le format mauvais du time off dashboard
** Review SUGA - May 12, 2025:
38:00 / week = 7:36 hours a day
So 10:00 = 10:00 - 7:36 = 2:24 hours of overtime

On a 40h / week contract, extra hours seems legit
*DO NOT* drop the DB! I have done tests.

*The contract does not change anything.*
It's just the *working hours* under _Employee/WorkInfo/Schedule/Working Hours_

* DONE [[https://www.odoo.com/odoo/my-tasks/4901052][[Salary Config] Allow fields of salary config to be archived]]
#+begin_src bash :results silent
../o --checkout-community master \
     --checkout-enterprise master-hr_contract_salary-archivable_salaries-mlef >&2
#+end_src
**master**
archiver = mettre: active = fields.boolean(default=false) dans model
clean db = remove the fields you don't like (not a real dropdb _at all_)
-i hr_contract_salary
File where ribbon component is:
[[project:community/addons/web/static/src/views/widgets/ribbon/ribbon.js::20][community/addons/web/static/src/views/widgets/ribbon/ribbon.js::20]]
** DONE forgot ribbon on benefits model
* CANCEL [[https://www.odoo.com/odoo/project/1251/tasks/4879294][[Payroll] When selecting employees from payrun, remove launch plan]]
* Configuration
#+name: Count number of tasks
#+begin_src elisp :results none
(save-excursion
  (goto-char (point-min))
  (let ((counts (make-hash-table :test 'equal)))
    (while (re-search-forward "^\\* \\([^[:space:]]+\\)" nil t)
      (let ((word (match-string 1)))
        (unless (string= word "Configuration")
          (puthash "Total" (1+ (or (gethash "Total" counts 0) 0)) counts)
          (puthash word (1+ (or (gethash word counts 0) 0)) counts)
		  )))
    (message (mapconcat
              (lambda (pair)
                (format "%s: %d" (car pair) (cdr pair)))
              (loop for k being the hash-keys of counts
                    using (hash-value v)
                    collect (cons k v))
              "\n")
             )))
#+END_src

# Local Variables:
# eval: (org-overview)
# End:
